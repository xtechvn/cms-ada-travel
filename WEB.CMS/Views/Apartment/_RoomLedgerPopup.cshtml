@using Entities.ViewModels.Apartment
@model ApartmentRoomLedgerViewModel

@using System.Globalization
<style>
    .input-auto {
        background-color: #eaf6ff !important;
        color: #004a80;
        cursor: not-allowed;
        font-weight: 600;
    }

</style>
@{
    var vi = new CultureInfo("vi-VN");

    // Chuẩn bị list dùng chung cho cả view
    var thuList = Model.Ledgers?
        .Where(x => x.LedgerType == 1)
        .ToList()
        ?? new List<ApartmentRoomLedger>();

    var chiList = Model.Ledgers?
        .Where(x => x.LedgerType == 2)
        .ToList()
        ?? new List<ApartmentRoomLedger>();

    int stt = 1;
    int stt2 = 1;

    // Tổng đã thanh toán (bảng Thu)
    var sumThuPaid = thuList.Sum(x => x.AmountPaid ?? 0);

    // Tổng phải thu = sum( Tiền nhà + Phí DV + Cọc )
    // Tiền nhà = RoomPrice * DurationMonth
    decimal sumThuMust = thuList.Sum(x =>
        ((x.RoomPrice ?? 0) * (x.DurationMonth ?? 0))
        + (x.ServiceFee ?? 0)
        + (x.DepositAmount ?? 0));

    // Tổng đã chi = sum( ExpenseAmount )
    var sumChiTotal = chiList.Sum(x => x.ExpenseAmount ?? 0);

    // Tổng lợi nhuận = Tổng phải thu - Tổng đã chi
    var profit = sumThuMust - sumChiTotal;
}

<div class="modal fade" id="myModal5">
    <div class="modal-dialog modal-xl" style="max-width: 1500px;">

        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">
                    Ledger phòng @Model.RoomInfo?.Name
                </h4>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="ledger_roomId" value="@Model.RoomInfo?.Id" />
                <input type="hidden" id="ledger_hotelId" value="@Model.RoomInfo?.HotelId" />

                <!-- ====================== BẢNG THU ====================== -->
                <div class="bold mb15 txt_14">Bảng Thu</div>

                <div class="table-responsive table-gray">
                    <table class="table table-nowrap" id="tblThu">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng</th>
                                <th>SĐT</th>
                                <th>Ngày HĐ</th>
                                <th>Thời hạn (tháng)</th>
                                <th>Hết hạn</th>
                                <th>Giá phòng</th>
                                <th>Phí DV</th>
                                <th>Tiền nhà</th>
                                <th>Tiền cọc</th>
                                <th>Tổng phải thu</th>
                                <th>Tổng đã thanh toán</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (thuList.Count > 0)
                            {
                                foreach (var t in thuList)
                                {
                                    var duration = t.DurationMonth ?? 0;
                                    var roomPrice = t.RoomPrice ?? 0;
                                    var rentAmount = roomPrice * duration;

                                    // Tổng phải thu = Tiền nhà + Phí DV + Cọc
                                    var totalMust = rentAmount
                                                    + (t.ServiceFee ?? 0)
                                                    + (t.DepositAmount ?? 0);

                                            <tr class="ledger-row">
                                                <td>@(stt++)</td>

                                                <td>
                                                    <input type="hidden" class="ledger-id" value="@t.Id" />
                                                    <input class="form-control customer" value="@t.CustomerName" />
                                                </td>

                                                <!-- SĐT -->
                                                <td>
                                                    <input class="form-control phone"
                                                           value="@t.PhoneNumber" />
                                                </td>

                                                <!-- Ngày HĐ -->
                                                <td>
                                                    <input type="date"
                                                           class="form-control date-contract"
                                                           value="@(t.ContractDate?.ToString("yyyy-MM-dd"))" />
                                                </td>

                                                <!-- Thời hạn (tháng) -->
                                                <td>
                                                    <input class="form-control duration-month"
                                                           value="@(t.DurationMonth?.ToString() ?? "")" />
                                                </td>

                                                <!-- Ngày hết hạn (readonly, auto = Ngày HĐ + Thời hạn) -->
                                                <td>
                                                    <input type="date"
                                                   class="form-control date-expire input-auto"
                                                           readonly
                                                   value="@(t.ContractExpired?.ToString("yyyy-MM-dd"))" />
                                                </td>

                                                <!-- GIÁ PHÒNG -->
                                                <td>
                                                    <input class="form-control room-price"
                                                           value="@(t.RoomPrice.HasValue ? t.RoomPrice.Value.ToString("N0", vi) : "")" />
                                                </td>

                                                <!-- PHÍ DV -->
                                                <td>
                                                    <input class="form-control service-fee"
                                                           value="@(t.ServiceFee.HasValue ? t.ServiceFee.Value.ToString("N0", vi) : "")" />
                                                </td>

                                                <!-- TIỀN NHÀ (auto) -->
                                                <td>
                                            <input class="form-control rent-amount input-auto"
                                                           readonly
                                                           value="@(rentAmount > 0 ? rentAmount.ToString("N0", vi) : "")" />
                                                </td>

                                                <!-- TIỀN CỌC -->
                                                <td>
                                                    <input class="form-control deposit-amount"
                                                           value="@(t.DepositAmount.HasValue ? t.DepositAmount.Value.ToString("N0", vi) : "")" />
                                                </td>

                                                <!-- TỔNG PHẢI THU (auto = Tiền nhà + Phí DV + Cọc) -->
                                                <td>
                                            <input class="form-control total-must-pay input-auto"
                                                           readonly
                                                           value="@(totalMust > 0 ? totalMust.ToString("N0", vi) : "")" />
                                                </td>

                                                <!-- TỔNG ĐÃ THANH TOÁN (AmountPaid) -->
                                                <td>
                                                    <input class="form-control total-paid"
                                                           value="@(t.AmountPaid.HasValue ? t.AmountPaid.Value.ToString("N0", vi) : "")" />
                                                </td>

                                                <td>
                                                    <a href="javascript:;" class="red remove-row">
                                                        <i class="fa fa-times"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                }
                            }
                            else
                            {
                                    <tr class="ledger-row">
                                        <td>1</td>

                                        <td>
                                            <input type="hidden" class="ledger-id" value="0" />
                                            <input class="form-control customer" />
                                        </td>

                                        <td><input class="form-control phone" /></td>

                                        <td><input type="date" class="form-control date-contract" /></td>

                                        <td><input class="form-control duration-month" /></td>

                                        <td><input type="date" class="form-control date-expire" readonly /></td>

                                        <td><input class="form-control room-price" /></td>
                                        <td><input class="form-control service-fee" /></td>

                                        <td><input class="form-control rent-amount" readonly /></td>

                                        <td><input class="form-control deposit-amount" /></td>

                                        <!-- TỔNG PHẢI THU -->
                                        <td>
                                            <input class="form-control total-must-pay" readonly />
                                        </td>

                                        <!-- TỔNG ĐÃ THANH TOÁN -->
                                        <td>
                                            <input class="form-control total-paid" />
                                        </td>

                                        <td>
                                            <a href="javascript:;" class="red remove-row">
                                                <i class="fa fa-times"></i>
                                            </a>
                                        </td>
                                    </tr>
                            }

                            <!-- Dòng Thêm + Tổng đã thanh toán -->
                            <tr>
                                <!-- Gom từ STT → Tiền cọc (10 cột đầu) -->
                                <td colspan="10">
                                    <a href="javascript:;" id="addThu" class="blue ml-2 mb10">
                                        <i class="fa fa-plus-circle green"></i> Thêm dòng
                                    </a>
                                </td>

                                <!-- Cột 11: label -->
                                <td class="text-right"><b>Tổng đã thanh toán:</b></td>

                                <!-- Cột 12: value -->
                                <td id="sumThu" class="text-right">
                                    @sumThuPaid.ToString("N0", vi)
                                </td>

                                <!-- Cột 13: trống -->
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <br />

                <!-- ====================== BẢNG CHI ====================== -->
                <div class="bold mb15 txt_14">Bảng Chi</div>

                <div class="table-responsive table-gray">
                    <table class="table table-nowrap" id="tblChi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Loại chi</th>
                                <th>Mô tả</th>
                                <th>Số tiền</th>
                                <th>Ngày tạo</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (chiList.Count > 0)
                            {
                                foreach (var c in chiList)
                                {
                                            <tr class="ledger-row">
                                                <td>@(stt2++)</td>

                                                <td>
                                                    <input type="hidden" class="ledger-id" value="@c.Id" />

                                                    <select class="form-control expense-type">
                                                        <option value="1" selected="@(c.ExpenseTypeId == 1 ? "selected" : null)">Hoa hồng</option>
                                                        <option value="2" selected="@(c.ExpenseTypeId == 2 ? "selected" : null)">Dịch vụ</option>
                                                    </select>
                                                </td>

                                                <td>
                                                    <input class="form-control expense-desc"
                                                           value="@c.Description" />
                                                </td>

                                                <!-- TIỀN CHI (ExpenseAmount) -->
                                                <td>
                                                    <input class="form-control expense-amount"
                                                           value="@(c.ExpenseAmount.HasValue ? c.ExpenseAmount.Value.ToString("N0", vi) : "")" />
                                                </td>

                                                <td>
                                                    <input type="date"
                                                           class="form-control expense-date"
                                                           value="@(c.ExpenseDate?.ToString("yyyy-MM-dd"))" />
                                                </td>

                                                <td>
                                                    <a href="javascript:;" class="red remove-row">
                                                        <i class="fa fa-times"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                }
                            }
                            else
                            {
                                    <tr class="ledger-row">
                                        <td>1</td>

                                        <td>
                                            <input type="hidden" class="ledger-id" value="0" />
                                            <select class="form-control expense-type">
                                                <option value="1">Hoa hồng</option>
                                                <option value="2">Dịch vụ</option>
                                            </select>
                                        </td>

                                        <td><input class="form-control expense-desc" /></td>
                                        <td><input class="form-control expense-amount" /></td>
                                        <td><input type="date" class="form-control expense-date" /></td>

                                        <td>
                                            <a href="javascript:;" class="red remove-row">
                                                <i class="fa fa-times"></i>
                                            </a>
                                        </td>
                                    </tr>
                            }

                            <!-- Tổng chi -->
                            <tr>
                                <td colspan="3">
                                    <a href="javascript:;" id="addChi" class="blue ml-2 mb10">
                                        <i class="fa fa-plus-circle green"></i> Thêm dòng
                                    </a>
                                </td>

                                <td class="text-right"><b>Tổng chi:</b></td>
                                <td id="sumChi" class="text-right">
                                    @sumChiTotal.ToString("N0", vi)
                                </td>
                                <td></td>
                            </tr>

                        </tbody>
                    </table>
                </div>

                <!-- ====================== TỔNG HỢP THU / CHI / LỢI NHUẬN ====================== -->
                <div class="row mt-3">
                    <div class="col-md-4 text-right">
                        <b>Tổng phải thu:</b>
                    </div>
                    <div class="col-md-2">
                        <span id="sumThuMust">
                            @sumThuMust.ToString("N0", vi)
                        </span>
                    </div>

                    <div class="col-md-3 text-right">
                        <b>Tổng đã chi:</b>
                    </div>
                    <div class="col-md-3">
                        <span id="sumChiTotal">
                            @sumChiTotal.ToString("N0", vi)
                        </span>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-md-4 text-right">
                        <b>Tổng lợi nhuận (Thu - Chi):</b>
                    </div>
                    <div class="col-md-2">
                        <span id="sumProfit">
                            @profit.ToString("N0", vi)
                        </span>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Đóng</button>
                <button class="btn btn-primary" onclick="_order_detail_create.saveRoomLedger()">Lưu</button>
            </div>

        </div>
    </div>
</div>
