@using System.Collections.Generic
@using System.Linq
@using Entities.ViewModels.Lock
@model Entities.ViewModels.Lock.DeviceHierarchyMapViewModel

@{
    ViewData["Title"] = "Full IoT Device Hierarchy Map";

    // ====== Data safe ======
    var gateways = Model?.Gateways ?? new List<GatewayWithLocksViewModel>();

    // ====== Stats ======
    var totalGateway = gateways.Count;

    var allLocks = gateways
        .SelectMany(x => x.Locks ?? new List<TTLockLockItem>())
        .ToList();

    var totalLocks = allLocks.Count;

    // Active theo electricQuantity > 0
    var totalLockActive = allLocks.Count(x => x.electricQuantity > 0);
    var totalLockLowBattery = allLocks.Count(x => x.electricQuantity <= 20);

    var avgSignal = totalLocks == 0 ? 0 : (int)System.Math.Round(allLocks.Average(x => x.rssi));
    var avgSignalText = totalLocks == 0 ? "--" : $"{avgSignal} dBm";

    var healthText =
        totalLockLowBattery == 0 ? "Excellent" :
        totalLockLowBattery <= 2 ? "Good" :
        "Needs Attention";

    // Bootstrap color class
    var healthColor =
        totalLockLowBattery == 0 ? "text-success" :
        totalLockLowBattery <= 2 ? "text-warning" :
        "text-danger";

    // ====== Top gateways (tối đa 3) ======
    var topGateways = gateways.Take(3).ToList();
    // ====== Locks in top gateways? ======
    var hasAnyLocksInTop = topGateways.Any(g => (g.Locks?.Count ?? 0) > 0);

    // Root info safe
    var rootName = Model?.RootName ?? "Main Server Node";
    var rootIp = Model?.RootIp ?? "192.168.1.100";
}



    <style>
        :root {
            --primary: #0d7ff2;
            --bg-light: #f5f7f8;
            --text: #0d141c;
            --muted: #49739c;
            --line: #cbd5e1;
        }

        /* Scope: chỉ ảnh hưởng trong trang này */
        .hierarchy-page {
            font-family: Manrope, sans-serif;
            background: var(--bg-light);
            color: var(--text);
            min-height: 100vh;
        }

            .hierarchy-page .text-primary-custom {
                color: var(--primary) !important;
            }

            .hierarchy-page .btn-primary-custom {
                background: var(--primary) !important;
                border-color: var(--primary) !important;
                color: #fff !important;
            }

            .hierarchy-page .btn-light-soft {
                background: #e7edf4;
                border-color: transparent;
                color: var(--text);
                font-weight: 700;
            }

            .hierarchy-page .card {
                border-radius: 14px;
                border-color: #e5e7eb;
            }

            .hierarchy-page .mono {
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            }

        .hierarchy-line-v {
            width: 2px;
            background-color: var(--line);
            height: 32px;
            margin: 0 auto;
        }

        .hierarchy-line-h {
            height: 2px;
            background-color: var(--line);
            width: 66%;
            margin: 0 auto;
        }

        .bg-primary-soft {
            background: rgba(13,127,242,.10);
        }

        /* Responsive: nếu < 992px thì line ngang full cho dễ nhìn */
        @@media (max-width: 991.98px) {
            .hierarchy-line-h {
                width: 100%;
            }
        }
    </style>


<div class="hierarchy-page">
    <main class="container py-4" style="max-width:1200px;">

        <!-- Page Heading -->
        <div class="d-flex flex-wrap justify-content-between align-items-end gap-3 mb-4">
            <div style="min-width:18rem;">
                <div class="fs-2 fw-black fw-bold mb-1">Device Hierarchy Map</div>
                <div class="text-secondary">Real-time visualization of network topology for gateways and smart locks.</div>
            </div>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                    <span class="material-symbols-outlined">filter_list</span>
                    Filter
                </button>

                <a href="@Url.Action("RefreshHard", "Lock")" class="btn btn-primary-custom d-flex align-items-center gap-2 shadow-sm">
                    <span class="material-symbols-outlined">sync</span>
                    Refresh Map
                </a>
            </div>
        </div>

        <!-- Hierarchy Visualization -->
        <div class="d-flex flex-column align-items-center">

            <!-- Tier 1: Root -->
            <div class="w-100 d-flex flex-column align-items-center">
                <div class="text-uppercase fw-bold small text-secondary mb-3" style="letter-spacing:.15em;">
                    Top Tier: Core Infrastructure
                </div>

                <div class="w-100" style="max-width:420px;">
                    <div class="card shadow-sm">
                        <div class="card-body d-flex justify-content-between gap-3">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="d-inline-block rounded-circle" style="width:8px;height:8px;background:#22c55e;"></span>
                                    <span class="text-primary-custom text-uppercase fw-bold small" style="letter-spacing:.12em;">ROOT NODE</span>
                                </div>

                                <div class="fw-bold fs-5">@rootName</div>
                                <div class="text-secondary">IP: @rootIp</div>
                                <div class="text-muted small">Uptime: 24d 14h 22m</div>

                                <button type="button" class="btn btn-light-soft mt-3">Manage Server</button>
                            </div>

                            <div class="rounded-3 bg-primary-soft d-flex align-items-center justify-content-center" style="width:96px;height:96px;">
                                <span class="material-symbols-outlined text-primary-custom" style="font-size:42px;">dns</span>
                            </div>
                        </div>
                    </div>
                </div>

                @if (totalGateway > 0)
                {
                    <div class="hierarchy-line-v"></div>
                    <div class="hierarchy-line-h"></div>
                }
            </div>

            @* ===== Tier 2 + Tier 3 ===== *@
            @if (totalGateway > 0)
            {
                <!-- Tier 2: Gateways -->
                <div class="row g-4 w-100 mt-0">
                    @foreach (var gwWrap in topGateways)
                    {
                        var gw = gwWrap.Gateway;
                        var online = gw != null && gw.isOnline == 1;
                        var avgSigText = gwWrap.AvgSignal == 0 ? "--" : $"{gwWrap.AvgSignal} dBm";

                        <div class="col-12 col-lg-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="hierarchy-line-v"></div>

                                <div class="card shadow-sm w-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge text-uppercase px-2 py-1"
                                                  style="font-size:10px; letter-spacing:.10em; font-weight:800;
                                                         @(online ? "background:#d1fae5;color:#065f46;" : "background:#fee2e2;color:#991b1b;")">
                                                @(online ? "Online" : "Offline")
                                            </span>

                                            <span class="material-symbols-outlined text-secondary">router</span>
                                        </div>

                                        <div class="fw-bold text-truncate">@((gw?.gatewayName) ?? "Unknown Gateway")</div>

                                        <div class="text-muted small mono mt-2">
                                            <div>GatewayId: @(gw?.gatewayId.ToString() ?? "--")</div>
                                            <div>MAC: @(gw?.gatewayMac ?? "--")</div>
                                        </div>

                                        <div class="text-muted small mt-2">
                                            <div class="d-flex justify-content-between gap-2">
                                                <span class="fw-semibold">Network:</span>
                                                <span class="text-truncate" style="max-width: 220px;">@((gw?.networkName) ?? "--")</span>
                                            </div>
                                            <div class="d-flex justify-content-between gap-2">
                                                <span class="fw-semibold">Serial:</span>
                                                <span class="text-truncate" style="max-width: 220px;">@((gw?.serialNumber) ?? "--")</span>
                                            </div>
                                        </div>

                                        <hr class="my-3" />

                                        <div class="d-flex justify-content-between align-items-center text-muted small">
                                            <span>Connected Locks: @gwWrap.LockCount</span>
                                            <span class="text-primary-custom fw-bold">@avgSigText</span>
                                        </div>
                                    </div>
                                </div>

                                @if ((gwWrap.Locks?.Count ?? 0) > 0)
                                {
                                    <div class="hierarchy-line-v"></div>
                                    <div class="hierarchy-line-h" style="width:100%"></div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Tier 3: Locks -->
                @if (hasAnyLocksInTop)
                {
                    <div class="row g-4 w-100 mt-0">
                        @foreach (var gwWrap in topGateways)
                        {
                            var locks = gwWrap.Locks ?? new List<TTLockLockItem>();

                            <div class="col-12 col-lg-4">
                                @if (locks.Count > 0)
                                {
                                    <div class="text-center">
                                        <div class="hierarchy-line-v" style="height:16px;"></div>
                                    </div>

                                    @foreach (var item in locks)
                                    {
                                        var low = item.electricQuantity <= 20;
                                        var mid = item.electricQuantity > 20 && item.electricQuantity <= 50;

                                        var batteryIcon = low ? "battery_2_bar" : (mid ? "battery_6_bar" : "battery_full");
                                        var batteryClass = low ? "text-danger" : (mid ? "text-warning" : "text-success");

                                        var weakSignal = item.rssi <= -75;
                                        var sigClass = weakSignal ? "text-warning" : "text-secondary";
                                        var rssiClass = weakSignal ? "text-warning fw-semibold" : "text-muted";

                                        <div class="card shadow-sm mb-3">
                                            <div class="card-body py-3 d-flex justify-content-between align-items-start">
                                                <div class="min-w-0">
                                                    <div class="fw-bold small text-truncate">@item.lockName</div>
                                                    <div class="text-muted" style="font-size:12px;">
                                                        <span class="mono">LockId: @item.lockId</span>
                                                    </div>

                                                    <div class="d-flex align-items-center gap-1 mt-1">
                                                        <span class="material-symbols-outlined @batteryClass" style="font-size:18px;">@batteryIcon</span>
                                                        <span style="font-size:12px;" class="@(low ? "text-danger fw-bold" : "text-muted")">
                                                            @item.electricQuantity%
                                                        </span>
                                                    </div>

                                                    <div class="text-muted text-truncate" style="font-size:12px;">@item.lockAlias</div>
                                                </div>

                                                <div class="text-end">
                                                    <span class="material-symbols-outlined @sigClass">signal_cellular_alt</span>
                                                    <div style="font-size:12px;" class="@rssiClass">@item.rssi dBm</div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- Footer Stats -->
        <div class="row g-4 mt-4 pt-4 border-top">
            <div class="col-6 col-lg-3">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Total Gateways</div>
                <div class="fs-3 fw-bold">@totalGateway</div>
            </div>

            <div class="col-6 col-lg-3">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Total Locks</div>
                <div class="fs-3 fw-bold">@totalLocks</div>
            </div>

            <div class="col-6 col-lg-3">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Total Locks Active</div>
                <div class="fs-3 fw-bold text-success">@totalLockActive</div>
            </div>

            <div class="col-6 col-lg-3">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Total Locks Deactive</div>
                <div class="fs-3 fw-bold text-danger">@totalLockLowBattery</div>
            </div>
        </div>

        <!-- Extra Stats -->
        <div class="row g-4 mt-2">
            <div class="col-12 col-lg-6">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Avg Signal</div>
                <div class="fs-3 fw-bold">@avgSignalText</div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="text-uppercase fw-bold small text-secondary" style="letter-spacing:.12em;">Network Health</div>
                <div class="fs-3 fw-bold @healthColor">@healthText</div>
            </div>
        </div>

    </main>
</div>
